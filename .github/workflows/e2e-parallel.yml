name: E2E Parallel Pipeline

on:
  workflow_dispatch:
    inputs:
      axon_version:
        description: 'Axon version to test'
        required: false
        default: 'v3.1.1'
      core_version:
        description: 'Core version to test'
        required: false
        default: '3.2.5-alpha'
      models:
        description: 'Comma-separated model names (empty = all enabled)'
        required: false
        default: ''
      parallel_jobs:
        description: 'Number of parallel model tests (1 = sequential)'
        required: false
        default: '3'

permissions:
  contents: write
  pages: write
  id-token: write
  packages: read

jobs:
  # ============================================================================
  # SINGLE RUNNER: All tests on one machine for consistent performance metrics
  # ============================================================================
  e2e-test:
    name: E2E Test (Single Runner)
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyyaml
          sudo apt-get update && sudo apt-get install -y curl tar jq
      
      - name: Get enabled models
        id: get-models
        run: |
          if [ -n "${{ github.event.inputs.models }}" ]; then
            MODELS="${{ github.event.inputs.models }}"
          else
            MODELS=$(python3 -c "
          import yaml
          with open('config/models.yaml') as f:
              config = yaml.safe_load(f)
          models = [name for name, m in config.get('models', {}).items() if m.get('enabled', False)]
          print(' '.join(models))
          ")
          fi
          echo "models=$MODELS" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Models to test: $MODELS"
      
      - name: Download Axon release
        run: |
          VERSION="${{ github.event.inputs.axon_version || 'v3.1.1' }}"
          OS="linux"
          ARCH=$(uname -m)
          case $ARCH in
            x86_64) ARCH="amd64" ;;
            aarch64) ARCH="arm64" ;;
          esac
          
          ARTIFACT="axon_${VERSION#v}_${OS}_${ARCH}.tar.gz"
          URL="https://github.com/mlOS-foundation/axon/releases/download/${VERSION}/${ARTIFACT}"
          
          echo "ðŸ“¥ Downloading Axon from: $URL"
          mkdir -p ~/.local/bin
          curl -L -f -o "/tmp/${ARTIFACT}" "$URL"
          tar -xzf "/tmp/${ARTIFACT}" -C ~/.local/bin
          chmod +x ~/.local/bin/axon
          ~/.local/bin/axon version
      
      - name: Download converter image (ONCE)
        run: |
          VERSION="${{ github.event.inputs.axon_version || 'v3.1.1' }}"
          OS="linux"
          ARCH=$(uname -m)
          case $ARCH in
            x86_64) ARCH="amd64" ;;
            aarch64) ARCH="arm64" ;;
          esac
          
          CONVERTER="axon-converter-${VERSION#v}-${OS}-${ARCH}.tar.gz"
          URL="https://github.com/mlOS-foundation/axon/releases/download/${VERSION}/${CONVERTER}"
          echo "ðŸ“¥ Downloading converter image (once for all models)..."
          if curl -L -f -o "/tmp/${CONVERTER}" "$URL" 2>/dev/null; then
            docker load -i "/tmp/${CONVERTER}"
            docker tag "ghcr.io/mlos-foundation/axon-converter:${VERSION#v}" "ghcr.io/mlos-foundation/axon-converter:latest" || true
            echo "âœ… Converter image loaded"
          else
            echo "âš ï¸ Converter image not available, will use fallback"
          fi
      
      - name: Download Core release (ONCE)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.event.inputs.core_version || '3.2.5-alpha' }}"
          OS="linux"
          ARCH=$(uname -m)
          case $ARCH in
            x86_64) ARCH="amd64" ;;
            aarch64) ARCH="arm64" ;;
          esac
          
          mkdir -p ~/mlos-core
          
          # Try gh CLI first
          ARTIFACT="mlos-core_${VERSION}_${OS}-${ARCH}.tar.gz"
          echo "ðŸ“¥ Trying gh download: $ARTIFACT"
          if gh release download "${VERSION}" --pattern "$ARTIFACT" --repo mlOS-foundation/core -D /tmp 2>/dev/null; then
            echo "âœ… Downloaded via gh CLI"
            tar -xzf "/tmp/$ARTIFACT" -C ~/mlos-core
          else
            # Fallback to core-releases
            RELEASE_TAG="v${VERSION}"
            [[ "$VERSION" =~ ^v ]] && RELEASE_TAG="$VERSION"
            URL="https://github.com/mlOS-foundation/core-releases/releases/download/${RELEASE_TAG}/${ARTIFACT}"
            echo "ðŸ“¥ Trying curl from: $URL"
            if curl -L -f -o "/tmp/core.tar.gz" "$URL" 2>/dev/null; then
              echo "âœ… Downloaded via curl"
              tar -xzf "/tmp/core.tar.gz" -C ~/mlos-core
            else
              echo "âŒ Failed to download Core"
              exit 1
            fi
          fi
          
          # Download ONNX Runtime
          ONNX_ARCH="x64"
          [ "$(uname -m)" = "aarch64" ] && ONNX_ARCH="aarch64"
          curl -L -f -o /tmp/onnx.tgz "https://github.com/microsoft/onnxruntime/releases/download/v1.18.0/onnxruntime-linux-${ONNX_ARCH}-1.18.0.tgz"
          mkdir -p ~/mlos-core/build
          tar -xzf /tmp/onnx.tgz -C ~/mlos-core/build
          mv ~/mlos-core/build/onnxruntime-* ~/mlos-core/build/onnxruntime
      
      - name: Start Core server (ONCE)
        run: |
          cd ~/mlos-core
          BINARY=$(find . -name "mlos_core" -o -name "mlos-server" 2>/dev/null | head -1)
          if [ -z "$BINARY" ]; then
            # Try nested directory
            BINARY=$(find . -type f -executable -name "mlos_core" 2>/dev/null | head -1)
          fi
          
          if [ -z "$BINARY" ]; then
            echo "âŒ Core binary not found"
            find . -type f -name "*mlos*" 2>/dev/null
            exit 1
          fi
          
          echo "ðŸ“ Found Core binary: $BINARY"
          chmod +x "$BINARY"
          
          export LD_LIBRARY_PATH="$(pwd)/build/onnxruntime/lib:$LD_LIBRARY_PATH"
          echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH" >> $GITHUB_ENV
          
          # Start Core in background
          nohup $BINARY --http-port 18080 > /tmp/core.log 2>&1 &
          echo $! > /tmp/core.pid
          echo "ðŸš€ Core started with PID $(cat /tmp/core.pid)"
          
          # Wait for Core to be ready
          for i in {1..30}; do
            if curl -s http://127.0.0.1:18080/health >/dev/null 2>&1; then
              echo "âœ… Core server ready"
              break
            fi
            echo "â³ Waiting for Core... ($i/30)"
            sleep 1
          done
          
          if ! curl -s http://127.0.0.1:18080/health >/dev/null 2>&1; then
            echo "âŒ Core failed to start"
            cat /tmp/core.log
            exit 1
          fi
      
      - name: Run all model tests
        id: test
        run: |
          MODELS="${{ steps.get-models.outputs.models }}"
          PARALLEL="${{ github.event.inputs.parallel_jobs || '3' }}"
          
          mkdir -p model-results
          chmod +x scripts/test-single-model.sh
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ§ª Testing $MODELS (parallel: $PARALLEL)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Run models with controlled parallelism using xargs
          echo "$MODELS" | tr ' ' '\n' | xargs -P "$PARALLEL" -I {} bash -c '
            echo "ðŸ”„ Starting test for: {}"
            ./scripts/test-single-model.sh "{}" \
              --output-dir model-results \
              --core-url http://127.0.0.1:18080 \
              --axon-path ~/.local/bin/axon \
              || echo "âš ï¸ {} test had issues"
          '
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All model tests completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ls -la model-results/
        continue-on-error: true
      
      - name: Stop Core server
        if: always()
        run: |
          if [ -f /tmp/core.pid ]; then
            kill $(cat /tmp/core.pid) 2>/dev/null || true
            echo "ðŸ›‘ Core server stopped"
          fi
          
          echo "ðŸ“‹ Core logs:"
          cat /tmp/core.log 2>/dev/null | tail -100 || true
      
      - name: Aggregate results
        if: always()
        run: |
          mkdir -p output metrics
          
          python3 scripts/aggregate-results.py \
            --results-dir model-results \
            --output metrics/latest.json \
            --markdown output/RESULTS.md \
            --github-summary || echo "âš ï¸ Aggregation had issues"
          
          echo "ðŸ“Š Metrics:"
          cat metrics/latest.json 2>/dev/null || echo "{}"
      
      - name: Generate HTML report
        if: always()
        run: |
          python3 report/render.py \
            --metrics metrics/latest.json \
            --template report/template.html \
            --output output/index.html || echo "âš ï¸ Renderer failed"
          
          cp report/styles.css output/ 2>/dev/null || true
          
          # Fallback
          if [ ! -f output/index.html ]; then
            echo "<html><body><h1>E2E Results</h1><pre>$(cat output/RESULTS.md 2>/dev/null || echo 'No results')</pre></body></html>" > output/index.html
          fi
          
          ls -la output/
      
      - name: Upload metrics
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-metrics-${{ github.run_number }}
          path: metrics/
          retention-days: 90
      
      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-report-${{ github.run_number }}
          path: output/
          retention-days: 90
      
      - name: Upload model results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-model-results-${{ github.run_number }}
          path: model-results/
          retention-days: 30
      
      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-logs-${{ github.run_number }}
          path: /tmp/core.log
          retention-days: 30
      
      - name: Setup Pages
        if: always()
        uses: actions/configure-pages@v4
      
      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./output
      
      - name: Deploy to GitHub Pages
        if: always()
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Report**: https://mlos-foundation.github.io/system-test/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f metrics/latest.json ]; then
            python3 -c "
          import json
          try:
              with open('metrics/latest.json') as f:
                  m = json.load(f)
              print(f\"| Metric | Value |\")
              print(f\"|--------|-------|\")
              print(f\"| Models Tested | {m.get('total_models', 'N/A')} |\")
              print(f\"| Successful | {m.get('successful_models', 'N/A')} |\")
              print(f\"| Success Rate | {m.get('success_rate', 'N/A')}% |\")
          except:
              print('Results not available')
          " >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Benefits of Single Runner:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Consistent hardware for all models" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Comparable performance metrics" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Single Core instance" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No repeated downloads" >> $GITHUB_STEP_SUMMARY
