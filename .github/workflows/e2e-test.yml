name: E2E Test & Report

on:
  workflow_dispatch:
    inputs:
      axon_version:
        description: 'Axon version to test'
        required: false
        default: 'v3.1.1'
      core_version:
        description: 'Core version to test'
        required: false
        default: '3.2.1-alpha'
  # schedule:
  #   - cron: '0 0 * * 0'  # Weekly on Sunday

permissions:
  contents: write
  pages: write
  id-token: write
  packages: read

jobs:
  vet:
    name: Go Vet
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Run go vet
        run: go vet ./...
  
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: v1.64.8
          args: --timeout=5m
  
  e2e-test:
    name: E2E Test
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    needs: [vet, lint]
    steps:
      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h
      
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl tar jq
          pip install pyyaml
      
      - name: Ensure Docker is accessible
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ³ Docker Setup Check"
          docker --version || echo "âš ï¸  Docker CLI not found"
          docker ps 2>&1 || echo "âš ï¸  Docker daemon not accessible"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Install gh CLI
        run: |
          type -p curl >/dev/null || (apt-get update && apt-get install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install gh -y
      
      - name: Authenticate gh CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
      
      - name: Determine Versions
        id: versions
        run: |
          AXON_VERSION="${{ github.event.inputs.axon_version || 'v3.0.2' }}"
          CORE_VERSION="${{ github.event.inputs.core_version || '3.1.6-alpha' }}"
          echo "axon=$AXON_VERSION" >> $GITHUB_OUTPUT
          echo "core=$CORE_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Axon: $AXON_VERSION"
          echo "ğŸ“¦ Core: $CORE_VERSION"
      
      - name: Check disk space
        run: df -h
      
      - name: Run E2E tests
        env:
          AXON_RELEASE_VERSION: ${{ steps.versions.outputs.axon }}
          CORE_RELEASE_VERSION: ${{ steps.versions.outputs.core }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§ª Running E2E Tests"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Update versions in the script
          sed -i "s/AXON_RELEASE_VERSION=.*/AXON_RELEASE_VERSION=\"${AXON_RELEASE_VERSION}\"/" scripts/test-release-e2e.sh.bash
          sed -i "s/CORE_RELEASE_VERSION=.*/CORE_RELEASE_VERSION=\"${CORE_RELEASE_VERSION}\"/" scripts/test-release-e2e.sh.bash
          
          # Run test script
          chmod +x scripts/test-release-e2e.sh.bash
          cd scripts && ./test-release-e2e.sh.bash || true
          
          # Move results
          if [ -d release-test-* ]; then
            TEST_DIR=$(ls -d release-test-* | head -1)
            mv "$TEST_DIR" ../e2e-results
          fi
        continue-on-error: true
      
      - name: Generate metrics JSON
        if: always()
        env:
          AXON_RELEASE_VERSION: ${{ steps.versions.outputs.axon }}
          CORE_RELEASE_VERSION: ${{ steps.versions.outputs.core }}
        run: |
          echo "ğŸ“Š Generating metrics JSON..."
          mkdir -p scripts/metrics
          python3 scripts/generate-metrics.py
      
      - name: Render HTML report
        if: always()
        run: |
          echo "ğŸ¨ Rendering HTML report..."
          mkdir -p output
          
          python3 report/render.py \
            --metrics scripts/metrics/latest.json \
            --template report/template.html \
            --output output/index.html || echo "âš ï¸ Renderer failed"
          
          cp report/styles.css output/ 2>/dev/null || true
          
          # Fallback to legacy report
          if [ ! -f output/index.html ]; then
            LEGACY=$(find . -name "release-validation-report.html" | head -1)
            if [ -f "$LEGACY" ]; then
              cp "$LEGACY" output/index.html
            else
              echo "<html><body><h1>E2E Report</h1><p>Report generation failed.</p></body></html>" > output/index.html
            fi
          fi
          
          ls -la output/
      
      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-report-${{ github.run_number }}
          path: output/
          retention-days: 90
      
      - name: Upload metrics artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-metrics-${{ github.run_number }}
          path: scripts/metrics/latest.json
          retention-days: 90
      
      - name: Upload logs artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-logs-${{ github.run_number }}
          path: |
            e2e-results/mlos-core/logs/**
            e2e-results/test.log
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Setup Pages
        if: always()
        uses: actions/configure-pages@v4
      
      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./output
      
      - name: Deploy to GitHub Pages
        if: always()
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š E2E Test Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ -f output/index.html ]; then
            echo "âœ… Report generated"
            echo "ğŸŒ https://mlos-foundation.github.io/system-test/"
          else
            echo "âš ï¸  Report not generated"
          fi
