name: Scheduled E2E & Pages Deploy

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight UTC
  workflow_dispatch:
    inputs:
      axon_version:
        description: 'Axon version to test'
        required: false
        default: 'v3.0.2'
      core_version:
        description: 'Core version to test'
        required: false
        default: '3.1.6-alpha'

permissions:
  contents: write
  pages: write
  id-token: write
  packages: read

jobs:
  build-and-deploy:
    name: Build Report & Deploy
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h
      
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl tar jq
          pip install pyyaml
      
      - name: Ensure Docker is accessible
        run: |
          docker --version || echo "âš ï¸  Docker CLI not found"
          docker ps 2>&1 || echo "âš ï¸  Docker daemon not accessible"
      
      - name: Install gh CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install gh -y
      
      - name: Authenticate gh CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
      
      - name: Determine Versions
        id: versions
        run: |
          AXON_VERSION="${{ github.event.inputs.axon_version || 'v3.1.2' }}"
          CORE_VERSION="${{ github.event.inputs.core_version || '3.2.6-alpha' }}"
          echo "axon=$AXON_VERSION" >> $GITHUB_OUTPUT
          echo "core=$CORE_VERSION" >> $GITHUB_OUTPUT
      
      - name: Run E2E tests
        env:
          AXON_RELEASE_VERSION: ${{ steps.versions.outputs.axon }}
          CORE_RELEASE_VERSION: ${{ steps.versions.outputs.core }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§ª Running E2E Tests"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          sed -i "s/AXON_RELEASE_VERSION=.*/AXON_RELEASE_VERSION=\"${AXON_RELEASE_VERSION}\"/" scripts/test-release-e2e.sh.bash
          sed -i "s/CORE_RELEASE_VERSION=.*/CORE_RELEASE_VERSION=\"${CORE_RELEASE_VERSION}\"/" scripts/test-release-e2e.sh.bash
          
          chmod +x scripts/test-release-e2e.sh.bash
          cd scripts && ./test-release-e2e.sh.bash || true
          cd ..
          
          if [ -d scripts/release-test-* ]; then
            mv scripts/release-test-* e2e-results
          fi
        continue-on-error: true
      
      - name: Generate metrics JSON
        if: always()
        env:
          AXON_RELEASE_VERSION: ${{ steps.versions.outputs.axon }}
          CORE_RELEASE_VERSION: ${{ steps.versions.outputs.core }}
        run: |
          mkdir -p scripts/metrics
          python3 scripts/generate-metrics.py
      
      - name: Render HTML report
        if: always()
        run: |
          mkdir -p output
          
          python3 report/render.py \
            --metrics scripts/metrics/latest.json \
            --template report/template.html \
            --output output/index.html || true
          
          cp report/styles.css output/ 2>/dev/null || true
          
          if [ ! -f output/index.html ]; then
            LEGACY=$(find . -name "release-validation-report.html" | head -1)
            if [ -f "$LEGACY" ]; then
              cp "$LEGACY" output/index.html
            else
              echo "<html><body><h1>E2E Report</h1><p>Pending...</p></body></html>" > output/index.html
          fi
          fi
          
          ls -la output/
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./output
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Deployment Complete"
          echo "ğŸŒ https://mlos-foundation.github.io/system-test/"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
